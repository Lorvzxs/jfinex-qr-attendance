<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JFINEX QR Maker - Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/kjua@0.9.0/dist/kjua.min.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; padding: 30px; background-color: #f8f9fa; }
        .card { background: white; padding: 25px; border-radius: 12px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 450px; }
        input { padding: 12px; width: 90%; border: 2px solid #ddd; border-radius: 6px; font-size: 15px; margin-bottom: 5px; text-transform: uppercase; }
        .btn-gen { background-color: #007bff; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        #download-btn { background-color: #28a745; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; display: none; width: 100%; }
        #preview-canvas { margin-top: 20px; background: white; border: 1px solid #ddd; max-width: 100%; cursor: pointer; }
        #qrcode-container { display: none; }
    </style>
</head>
<body>

    <div class="card">
        <h3>JFINEX QR Code Generator</h3>
        <p style="font-size: 11px; color: #666;">PARA SA ATTENDANCE!!!</p>
        
        <input type="text" id="text-input" placeholder="SECTION-SURNAME, FIRSTNAME MI">
        
        <button class="btn-gen" onclick="generateNow()">GENERATE QR CODE</button>
        
        <canvas id="preview-canvas"></canvas>
        <div id="qrcode-container"></div>
        
        <br>
        <button id="download-btn" onclick="downloadImage()">DOWNLOAD IMAGE HERE</button>
    </div>

    <script>
   function generateNow() {
    const inputEl = document.getElementById("text-input");
    const val = inputEl.value.trim().toUpperCase();

    if (!val) return alert("BUTANGIG PANGALAN LANGLANG!");

    // FIXED REGEX: Gidugangan og \. para sa Middle Initial nga naay tuldok
    const pattern = /^((1[A-G]|2[A-G]|3[A-E]|4[A-G])-[A-ZÑ\s]+,\s[A-ZÑ\s\.]+)+$/;

    if (!pattern.test(val)) {
        return alert(
            "MALI IMONG FORMAT NGART!\n\n" +
            "Dapat magsugod sa:\n" +
            "- 1A to 1G\n" +
            "- 2A to 2G\n" +
            "- 3A to 3E\n" +
            "- 4A to 4G\n\n" +
            "Sample: 1A-DELA CRUZ, JUAN A."
        );
    }

    const container = document.getElementById("qrcode-container");
    container.innerHTML = "";

    const el = kjua({
        render: 'canvas',
        text: val,
        size: 300,
        fill: '#000000',
        back: '#FFFFFF',
        ecLevel: 'H'
    });

    container.appendChild(el);
    
    setTimeout(() => {
        drawToPreview(el, val);
    }, 100);
}

    function drawToPreview(qrCanvas, label) {
        const canvas = document.getElementById("preview-canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 420;
        canvas.height = 450;
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000000";
        ctx.font = "bold 18px Arial";
        ctx.textAlign = "center";
        ctx.fillText("FINANCIALISTAS QR CODE", canvas.width / 2, 40);
        ctx.drawImage(qrCanvas, (canvas.width - 300) / 2, 70, 300, 300);
        ctx.font = "bold 20px Arial";
        ctx.fillText(label, canvas.width / 2, canvas.height - 40);
        document.getElementById("download-btn").style.display = "block";
    }

    function downloadImage() {
        const canvas = document.getElementById("preview-canvas");
        const link = document.createElement("a");
        const name = document.getElementById("text-input").value.replace(/[^A-Z0-9]/ig, "_");
        link.download = `QR_${name}.jpg`;
        link.href = canvas.toDataURL("image/jpeg", 1.0);
        link.click();
    }
</script>
</body>
</html>